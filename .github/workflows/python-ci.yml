name: Python CI

on:
  push:
    branches: [main, setup-ruff, feature/*, task/*, bug/*, hotfix/*]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.12"
  # Whisper model cache location
  XDG_CACHE_HOME: ${{ github.workspace }}/.cache

jobs:
  # Linting job - runs fast, no heavy dependencies needed
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: uv-lint-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}-${{ hashFiles('backend/pyproject.toml') }}
          restore-keys: |
            uv-lint-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}-
            uv-lint-${{ runner.os }}-

      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --dev

      - name: Ruff format (check)
        working-directory: backend
        run: |
          uv run ruff format --check .

      - name: Ruff lint (check)
        working-directory: backend
        run: |
          uv run ruff check .

      - name: Pyright type check
        working-directory: backend
        run: |
          uv run pyright

  # Unit tests - run without external services
  test-unit:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: uv-test-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}-${{ hashFiles('backend/pyproject.toml') }}
          restore-keys: |
            uv-test-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}-
            uv-test-${{ runner.os }}-

      - name: Cache Whisper models
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.cache/whisper
          key: whisper-${{ runner.os }}-base
          restore-keys: |
            whisper-${{ runner.os }}-

      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --dev

      - name: Cache pytest cache
        uses: actions/cache@v4
        with:
          path: backend/.pytest_cache
          key: pytest-${{ runner.os }}-${{ hashFiles('backend/tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-

      - name: Run unit tests
        working-directory: backend
        run: |
          # Run unit tests (excluding integration tests that require running backend)
          uv run pytest tests/test_unit.py -v --tb=short

  # CI Summary job - aggregates all results
  ci-summary:
    runs-on: ubuntu-latest
    needs: [lint, test-unit]
    if: always()
    steps:
      - name: Generate CI Summary
        run: |
          echo "# Python CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test-unit.result == 'success' && 'Passed' || 'Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.test-unit.result }}" == "success" ]; then
            echo "All checks passed - ready for review!" >> $GITHUB_STEP_SUMMARY
          else
            echo "Some checks failed - please review the logs above." >> $GITHUB_STEP_SUMMARY
          fi
