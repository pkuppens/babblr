name: CI

on:
  push:
    branches: [main, feature/*, task/*, bug/*, hotfix/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Concurrency control: Cancel in-progress runs for the same workflow on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Global environment variables with semantic names
env:
  # Python version configuration
  SUPPORTED_PYTHON_VERSIONS: '["3.11", "3.12"]'
  RELEASE_PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  
  # Cache configuration
  CACHE_WHISPER_MODELS: true
  ARTIFACT_RETENTION_DAYS: 90
  
  # Test configuration
  RUN_INTEGRATION_TESTS_ON_PR: false
  RUN_INTEGRATION_TESTS_ON_MAIN: true
  
  # Whisper model cache location
  XDG_CACHE_HOME: ${{ github.workspace }}/.cache

# Default permissions (least privilege)
permissions:
  contents: read

jobs:
  # Backend linting - runs fast with fail-fast enabled
  backend-lint:
    name: Backend Lint (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        python-version: ${{ fromJSON('["3.11", "3.12"]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: uv-lint-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('backend/uv.lock') }}-${{ hashFiles('backend/pyproject.toml') }}
          restore-keys: |
            uv-lint-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('backend/uv.lock') }}-
            uv-lint-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --dev

      - name: Ruff format (check)
        working-directory: backend
        run: |
          uv run ruff format --check .

      - name: Ruff lint (check)
        working-directory: backend
        run: |
          uv run ruff check .

      - name: Pyright type check
        working-directory: backend
        run: |
          uv run pyright

  # Backend unit tests - runs after lint passes
  backend-test-unit:
    name: Backend Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: backend-lint
    strategy:
      fail-fast: true
      matrix:
        python-version: ${{ fromJSON('["3.11", "3.12"]') }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: uv-test-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('backend/uv.lock') }}-${{ hashFiles('backend/pyproject.toml') }}
          restore-keys: |
            uv-test-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('backend/uv.lock') }}-
            uv-test-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Cache Whisper models
        if: env.CACHE_WHISPER_MODELS == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.cache/whisper
          key: whisper-${{ runner.os }}-base
          restore-keys: |
            whisper-${{ runner.os }}-

      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --dev

      - name: Cache pytest cache
        uses: actions/cache@v4
        with:
          path: backend/.pytest_cache
          key: pytest-${{ runner.os }}-py${{ matrix.python-version }}-${{ hashFiles('backend/tests/**/*.py') }}
          restore-keys: |
            pytest-${{ runner.os }}-py${{ matrix.python-version }}-

      - name: Run unit tests
        working-directory: backend
        run: |
          # Run unit tests (excluding integration tests that require running backend)
          # Use -n auto for parallel execution (adapts to available cores)
          uv run pytest tests/test_unit.py -v --tb=short -n auto

  # Backend integration tests - only on main branch or labeled PRs
  backend-test-integration:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    needs: backend-test-unit
    if: |
      github.ref == 'refs/heads/main' ||
      contains(github.event.pull_request.labels.*.name, 'run-integration')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.RELEASE_PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.RELEASE_PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Cache UV dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/.local/share/uv
          key: uv-integration-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}-${{ hashFiles('backend/pyproject.toml') }}
          restore-keys: |
            uv-integration-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}-
            uv-integration-${{ runner.os }}-

      - name: Cache Whisper models
        if: env.CACHE_WHISPER_MODELS == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ${{ github.workspace }}/.cache/whisper
          key: whisper-${{ runner.os }}-base
          restore-keys: |
            whisper-${{ runner.os }}-

      - name: Install dependencies
        working-directory: backend
        run: |
          uv sync --dev

      - name: Run integration tests
        working-directory: backend
        env:
          # Use unique IDs per run for idempotent integration tests
          TEST_RUN_ID: ${{ github.run_id }}-${{ github.run_attempt }}
        run: |
          uv run pytest tests/test_integration.py -v --tb=short

  # Frontend linting and tests
  frontend-test:
    name: Frontend Lint & Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run ESLint
        working-directory: frontend
        run: npm run lint

      - name: Check formatting
        working-directory: frontend
        run: npm run format -- --check

      - name: Run tests
        working-directory: frontend
        run: npm run test

      - name: Build
        working-directory: frontend
        run: npm run build

  # Markdown checks
  markdown-check:
    name: Markdown Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.RELEASE_PYTHON_VERSION }}

      - name: Install pre-commit
        run: python -m pip install --upgrade pip pre-commit

      - name: Run merge-conflict marker check
        run: pre-commit run check-merge-conflict --all-files

      - name: Run local Markdown link target validation
        run: pre-commit run check-markdown-local-links --all-files

      - name: Run Markdown linting
        run: pre-commit run markdownlint-cli2 --all-files

      - name: Run Markdown link/reference validation
        run: pre-commit run remark-validate-links --all-files

  # CI Summary job - aggregates all results
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend-lint, backend-test-unit, backend-test-integration, frontend-test, markdown-check]
    if: always()
    permissions:
      contents: read
    steps:
      - name: Generate CI Summary
        run: |
          echo "# CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Lint | ${{ needs.backend-lint.result == 'success' && '✅ Passed' || needs.backend-lint.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Unit Tests | ${{ needs.backend-test-unit.result == 'success' && '✅ Passed' || needs.backend-test-unit.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Integration Tests | ${{ needs.backend-test-integration.result == 'success' && '✅ Passed' || needs.backend-test-integration.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Lint & Test | ${{ needs.frontend-test.result == 'success' && '✅ Passed' || needs.frontend-test.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown Checks | ${{ needs.markdown-check.result == 'success' && '✅ Passed' || needs.markdown-check.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.backend-lint.result }}" == "success" ] && \
             [ "${{ needs.backend-test-unit.result }}" == "success" ] && \
             ([ "${{ needs.backend-test-integration.result }}" == "success" ] || [ "${{ needs.backend-test-integration.result }}" == "skipped" ]) && \
             [ "${{ needs.frontend-test.result }}" == "success" ] && \
             [ "${{ needs.markdown-check.result }}" == "success" ]; then
            echo "✅ **All checks passed - ready for review!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some checks failed - please review the logs above.**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Python versions: ${{ env.SUPPORTED_PYTHON_VERSIONS }}" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js version: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests on PR: ${{ env.RUN_INTEGRATION_TESTS_ON_PR }}" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests on main: ${{ env.RUN_INTEGRATION_TESTS_ON_MAIN }}" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        if: |
          needs.backend-lint.result != 'success' ||
          needs.backend-test-unit.result != 'success' ||
          (needs.backend-test-integration.result != 'success' && needs.backend-test-integration.result != 'skipped') ||
          needs.frontend-test.result != 'success' ||
          needs.markdown-check.result != 'success'
        run: |
          echo "One or more jobs failed"
          exit 1
